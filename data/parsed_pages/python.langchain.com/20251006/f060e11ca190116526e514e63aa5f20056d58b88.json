{
  "provenance": {
    "url_final": "https://python.langchain.com/docs/how_to/chat_token_usage_tracking/",
    "title": "How to track token usage in ChatModels | ðŸ¦œï¸ðŸ”— LangChain",
    "fetched_at": "2025-10-06T21:55:07.046146"
  },
  "sections": [
    {
      "level": 1,
      "heading_text": "How to track token usage in ChatModels | ðŸ¦œï¸ðŸ”— LangChain",
      "blocks": [
        {
          "type": "paragraph",
          "text": "This guide assumes familiarity with the following concepts:"
        },
        {
          "type": "list",
          "ordered": false,
          "items": [
            "Chat models"
          ]
        },
        {
          "type": "paragraph",
          "text": "Tracking token usage to calculate cost is an important part of putting your app in production. This guide goes over how to obtain this information from your LangChain model calls."
        },
        {
          "type": "paragraph",
          "text": "This guide requires langchain-anthropic and langchain-openai >= 0.3.11."
        },
        {
          "type": "code",
          "code": "%pip install -qU langchain-anthropic langchain-openai"
        },
        {
          "type": "paragraph",
          "text": "OpenAI's Chat Completions API does not stream token usage statistics by default (see API reference here). To recover token counts when streaming with ChatOpenAI or AzureChatOpenAI, set stream_usage=True as demonstrated in this guide."
        }
      ],
      "children": [
        {
          "level": 2,
          "heading_text": "Using LangSmithâ€‹",
          "anchor": "using-langsmith",
          "blocks": [
            {
              "type": "paragraph",
              "text": "You can use LangSmith to help track token usage in your LLM application. See the LangSmith quick start guide."
            }
          ],
          "children": []
        },
        {
          "level": 2,
          "heading_text": "Using AIMessage.usage_metadataâ€‹",
          "anchor": "using-aimessageusage_metadata",
          "blocks": [
            {
              "type": "paragraph",
              "text": "A number of model providers return token usage information as part of the chat generation response. When available, this information will be included on the AIMessage objects produced by the corresponding model."
            },
            {
              "type": "paragraph",
              "text": "LangChain AIMessage objects include a usage_metadata attribute. When populated, this attribute will be a UsageMetadata dictionary with standard keys (e.g., \"input_tokens\" and \"output_tokens\"). They will also include information on cached token usage and tokens from multi-modal data."
            },
            {
              "type": "paragraph",
              "text": "Examples:"
            },
            {
              "type": "paragraph",
              "text": "OpenAI:"
            },
            {
              "type": "code",
              "code": "from langchain.chat_models import init_chat_modelllm = init_chat_model(model=\"gpt-4o-mini\")openai_response = llm.invoke(\"hello\")openai_response.usage_metadata"
            },
            {
              "type": "code",
              "code": "{'input_tokens': 8, 'output_tokens': 9, 'total_tokens': 17}"
            },
            {
              "type": "paragraph",
              "text": "Anthropic:"
            },
            {
              "type": "code",
              "code": "from langchain_anthropic import ChatAnthropicllm = ChatAnthropic(model=\"claude-3-haiku-20240307\")anthropic_response = llm.invoke(\"hello\")anthropic_response.usage_metadata"
            },
            {
              "type": "code",
              "code": "{'input_tokens': 8, 'output_tokens': 12, 'total_tokens': 20}"
            }
          ],
          "children": [
            {
              "level": 3,
              "heading_text": "Streamingâ€‹",
              "anchor": "streaming",
              "blocks": [
                {
                  "type": "paragraph",
                  "text": "Some providers support token count metadata in a streaming context."
                },
                {
                  "type": "paragraph",
                  "text": "For example, OpenAI will return a message chunk at the end of a stream with token usage information. This behavior is supported by langchain-openai >= 0.1.9 and can be enabled by setting stream_usage=True. This attribute can also be set when ChatOpenAI is instantiated."
                },
                {
                  "type": "paragraph",
                  "text": "By default, the last message chunk in a stream will include a \"finish_reason\" in the message's response_metadata attribute. If we include token usage in streaming mode, an additional chunk containing usage metadata will be added to the end of the stream, such that \"finish_reason\" appears on the second to last message chunk."
                },
                {
                  "type": "code",
                  "code": "llm = init_chat_model(model=\"gpt-4o-mini\")aggregate = Nonefor chunk in llm.stream(\"hello\", stream_usage=True):    print(chunk)    aggregate = chunk if aggregate is None else aggregate + chunk"
                },
                {
                  "type": "code",
                  "code": "content='' id='run-adb20c31-60c7-43a2-99b2-d4a53ca5f623'content='Hello' id='run-adb20c31-60c7-43a2-99b2-d4a53ca5f623'content='!' id='run-adb20c31-60c7-43a2-99b2-d4a53ca5f623'content=' How' id='run-adb20c31-60c7-43a2-99b2-d4a53ca5f623'content=' can' id='run-adb20c31-60c7-43a2-99b2-d4a53ca5f623'content=' I' id='run-adb20c31-60c7-43a2-99b2-d4a53ca5f623'content=' assist' id='run-adb20c31-60c7-43a2-99b2-d4a53ca5f623'content=' you' id='run-adb20c31-60c7-43a2-99b2-d4a53ca5f623'content=' today' id='run-adb20c31-60c7-43a2-99b2-d4a53ca5f623'content='?' id='run-adb20c31-60c7-43a2-99b2-d4a53ca5f623'content='' response_metadata={'finish_reason': 'stop', 'model_name': 'gpt-4o-mini'} id='run-adb20c31-60c7-43a2-99b2-d4a53ca5f623'content='' id='run-adb20c31-60c7-43a2-99b2-d4a53ca5f623' usage_metadata={'input_tokens': 8, 'output_tokens': 9, 'total_tokens': 17}"
                },
                {
                  "type": "paragraph",
                  "text": "Note that the usage metadata will be included in the sum of the individual message chunks:"
                },
                {
                  "type": "code",
                  "code": "print(aggregate.content)print(aggregate.usage_metadata)"
                },
                {
                  "type": "code",
                  "code": "Hello! How can I assist you today?{'input_tokens': 8, 'output_tokens': 9, 'total_tokens': 17}"
                },
                {
                  "type": "paragraph",
                  "text": "To disable streaming token counts for OpenAI, set stream_usage to False, or omit it from the parameters:"
                },
                {
                  "type": "code",
                  "code": "aggregate = Nonefor chunk in llm.stream(\"hello\"):    print(chunk)"
                },
                {
                  "type": "code",
                  "code": "content='' id='run-8e758550-94b0-4cca-a298-57482793c25d'content='Hello' id='run-8e758550-94b0-4cca-a298-57482793c25d'content='!' id='run-8e758550-94b0-4cca-a298-57482793c25d'content=' How' id='run-8e758550-94b0-4cca-a298-57482793c25d'content=' can' id='run-8e758550-94b0-4cca-a298-57482793c25d'content=' I' id='run-8e758550-94b0-4cca-a298-57482793c25d'content=' assist' id='run-8e758550-94b0-4cca-a298-57482793c25d'content=' you' id='run-8e758550-94b0-4cca-a298-57482793c25d'content=' today' id='run-8e758550-94b0-4cca-a298-57482793c25d'content='?' id='run-8e758550-94b0-4cca-a298-57482793c25d'content='' response_metadata={'finish_reason': 'stop', 'model_name': 'gpt-4o-mini'} id='run-8e758550-94b0-4cca-a298-57482793c25d'"
                },
                {
                  "type": "paragraph",
                  "text": "You can also enable streaming token usage by setting stream_usage when instantiating the chat model. This can be useful when incorporating chat models into LangChain chains: usage metadata can be monitored when streaming intermediate steps or using tracing software such as LangSmith."
                },
                {
                  "type": "paragraph",
                  "text": "See the below example, where we return output structured to a desired schema, but can still observe token usage streamed from intermediate steps."
                },
                {
                  "type": "code",
                  "code": "from pydantic import BaseModel, Fieldclass Joke(BaseModel):    \"\"\"Joke to tell user.\"\"\"    setup: str = Field(description=\"question to set up a joke\")    punchline: str = Field(description=\"answer to resolve the joke\")llm = init_chat_model(    model=\"gpt-4o-mini\",    stream_usage=True,)# Under the hood, .with_structured_output binds tools to the# chat model and appends a parser.structured_llm = llm.with_structured_output(Joke)async for event in structured_llm.astream_events(\"Tell me a joke\"):    if event[\"event\"] == \"on_chat_model_end\":        print(f\"Token usage: {event['data']['output'].usage_metadata}\\n\")    elif event[\"event\"] == \"on_chain_end\" and event[\"name\"] == \"RunnableSequence\":        print(event[\"data\"][\"output\"])    else:        pass"
                },
                {
                  "type": "code",
                  "code": "Token usage: {'input_tokens': 79, 'output_tokens': 23, 'total_tokens': 102}setup='Why was the math book sad?' punchline='Because it had too many problems.'"
                },
                {
                  "type": "paragraph",
                  "text": "Token usage is also visible in the corresponding LangSmith trace in the payload from the chat model."
                }
              ],
              "children": []
            }
          ]
        },
        {
          "level": 2,
          "heading_text": "Using callbacksâ€‹",
          "anchor": "using-callbacks",
          "blocks": [
            {
              "type": "paragraph",
              "text": "LangChain implements a callback handler and context manager that will track token usage across calls of any chat model that returns usage_metadata."
            },
            {
              "type": "paragraph",
              "text": "There are also some API-specific callback context managers that maintain pricing for different models, allowing for cost estimation in real time. They are currently only implemented for the OpenAI API and Bedrock Anthropic API, and are available in langchain-community:"
            },
            {
              "type": "list",
              "ordered": false,
              "items": [
                "get_openai_callback",
                "get_bedrock_anthropic_callback"
              ]
            },
            {
              "type": "paragraph",
              "text": "Below, we demonstrate the general-purpose usage metadata callback manager. We can track token usage through configuration or as a context manager."
            }
          ],
          "children": [
            {
              "level": 3,
              "heading_text": "Tracking token usage through configurationâ€‹",
              "anchor": "tracking-token-usage-through-configuration",
              "blocks": [
                {
                  "type": "paragraph",
                  "text": "To track token usage through configuration, instantiate a UsageMetadataCallbackHandler and pass it into the config:"
                },
                {
                  "type": "code",
                  "code": "from langchain.chat_models import init_chat_modelfrom langchain_core.callbacks import UsageMetadataCallbackHandlerllm_1 = init_chat_model(model=\"openai:gpt-4o-mini\")llm_2 = init_chat_model(model=\"anthropic:claude-3-5-haiku-latest\")callback = UsageMetadataCallbackHandler()result_1 = llm_1.invoke(\"Hello\", config={\"callbacks\": [callback]})result_2 = llm_2.invoke(\"Hello\", config={\"callbacks\": [callback]})callback.usage_metadata"
                },
                {
                  "type": "code",
                  "code": "{'gpt-4o-mini-2024-07-18': {'input_tokens': 8,  'output_tokens': 10,  'total_tokens': 18,  'input_token_details': {'audio': 0, 'cache_read': 0},  'output_token_details': {'audio': 0, 'reasoning': 0}}, 'claude-3-5-haiku-20241022': {'input_tokens': 8,  'output_tokens': 21,  'total_tokens': 29,  'input_token_details': {'cache_read': 0, 'cache_creation': 0}}}"
                }
              ],
              "children": []
            },
            {
              "level": 3,
              "heading_text": "Tracking token usage using a context managerâ€‹",
              "anchor": "tracking-token-usage-using-a-context-manager",
              "blocks": [
                {
                  "type": "paragraph",
                  "text": "You can also use get_usage_metadata_callback to create a context manager and aggregate usage metadata there:"
                },
                {
                  "type": "code",
                  "code": "from langchain.chat_models import init_chat_modelfrom langchain_core.callbacks import get_usage_metadata_callbackllm_1 = init_chat_model(model=\"openai:gpt-4o-mini\")llm_2 = init_chat_model(model=\"anthropic:claude-3-5-haiku-latest\")with get_usage_metadata_callback() as cb:    llm_1.invoke(\"Hello\")    llm_2.invoke(\"Hello\")    print(cb.usage_metadata)"
                },
                {
                  "type": "code",
                  "code": "{'gpt-4o-mini-2024-07-18': {'input_tokens': 8, 'output_tokens': 10, 'total_tokens': 18, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}, 'claude-3-5-haiku-20241022': {'input_tokens': 8, 'output_tokens': 21, 'total_tokens': 29, 'input_token_details': {'cache_read': 0, 'cache_creation': 0}}}"
                },
                {
                  "type": "paragraph",
                  "text": "Either of these methods will aggregate token usage across multiple calls to each model. For example, you can use it in an agent to track token usage across repeated calls to one model:"
                },
                {
                  "type": "code",
                  "code": "%pip install -qU langgraph"
                },
                {
                  "type": "code",
                  "code": "from langgraph.prebuilt import create_react_agent# Create a tooldef get_weather(location: str) -> str:    \"\"\"Get the weather at a location.\"\"\"    return \"It's sunny.\"callback = UsageMetadataCallbackHandler()tools = [get_weather]agent = create_react_agent(\"openai:gpt-4o-mini\", tools)for step in agent.stream(    {\"messages\": [{\"role\": \"user\", \"content\": \"What's the weather in Boston?\"}]},    stream_mode=\"values\",    config={\"callbacks\": [callback]},):    step[\"messages\"][-1].pretty_print()print(f\"\\nTotal usage: {callback.usage_metadata}\")"
                },
                {
                  "type": "code",
                  "code": "================================\u001b[1m Human Message \u001b[0m=================================What's the weather in Boston?==================================\u001b[1m Ai Message \u001b[0m==================================Tool Calls:  get_weather (call_izMdhUYpp9Vhx7DTNAiybzGa) Call ID: call_izMdhUYpp9Vhx7DTNAiybzGa  Args:    location: Boston=================================\u001b[1m Tool Message \u001b[0m=================================Name: get_weatherIt's sunny.==================================\u001b[1m Ai Message \u001b[0m==================================The weather in Boston is sunny.Total usage: {'gpt-4o-mini-2024-07-18': {'input_token_details': {'audio': 0, 'cache_read': 0}, 'input_tokens': 125, 'total_tokens': 149, 'output_tokens': 24, 'output_token_details': {'audio': 0, 'reasoning': 0}}}"
                }
              ],
              "children": []
            }
          ]
        },
        {
          "level": 2,
          "heading_text": "Next stepsâ€‹",
          "anchor": "next-steps",
          "blocks": [
            {
              "type": "paragraph",
              "text": "You've now seen a few examples of how to track token usage for supported providers."
            },
            {
              "type": "paragraph",
              "text": "Next, check out the other how-to guides chat models in this section, like how to get a model to return structured output or how to add caching to your chat models."
            },
            {
              "type": "list",
              "ordered": false,
              "items": [
                "Streaming"
              ]
            },
            {
              "type": "list",
              "ordered": false,
              "items": [
                "Tracking token usage through configuration",
                "Tracking token usage using a context manager"
              ]
            }
          ],
          "children": []
        }
      ]
    }
  ]
}